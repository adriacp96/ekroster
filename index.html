<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#0b0b10" />
		<title>Ekroster | Airline Roster to Calendar</title>
		<link rel="manifest" href="manifest.json" />
		<link rel="icon" href="icons/icon-192.svg" type="image/svg+xml" />
		<link rel="apple-touch-icon" href="icons/icon-192.svg" />
		<link
			href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;600;800&family=Space+Grotesk:wght@300;500;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--ink: #0b0b10;
				--smoke: #eef0f4;
				--coal: #1a1d25;
				--sun: #f6a70b;
				--citrus: #f1c64e;
				--lagoon: #1b9aaa;
				--berry: #b63c79;
				--mist: rgba(255, 255, 255, 0.72);
				--glass: rgba(255, 255, 255, 0.2);
				--shadow: 0 24px 60px rgba(11, 11, 16, 0.25);
				--radius-xl: 28px;
				--radius-lg: 20px;
				--radius-md: 14px;
				--radius-sm: 10px;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
				color: var(--ink);
				background: radial-gradient(circle at top right, #ffe3a6, #f3f5f8 48%, #dbe5f7 100%);
				min-height: 100vh;
			}

			.page {
				padding: 48px 6vw 80px;
				display: grid;
				gap: 32px;
			}

			header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				flex-wrap: wrap;
				gap: 16px;
			}

			.brand {
				display: flex;
				align-items: center;
				gap: 16px;
			}

			.logo {
				width: 48px;
				height: 48px;
				border-radius: 16px;
				background: conic-gradient(from 180deg, #f6a70b, #b63c79, #1b9aaa, #f1c64e);
				box-shadow: 0 10px 25px rgba(182, 60, 121, 0.35);
			}

			.brand h1 {
				font-family: "Fraunces", serif;
				font-weight: 800;
				font-size: clamp(28px, 4vw, 44px);
				letter-spacing: -0.02em;
			}

			.tagline {
				color: rgba(11, 11, 16, 0.65);
				font-size: 15px;
			}

			.status-pill {
				display: inline-flex;
				align-items: center;
				gap: 10px;
				padding: 10px 16px;
				border-radius: 999px;
				background: var(--mist);
				border: 1px solid rgba(11, 11, 16, 0.08);
				font-size: 13px;
			}

			.pulse {
				width: 8px;
				height: 8px;
				border-radius: 50%;
				background: var(--lagoon);
				box-shadow: 0 0 0 6px rgba(27, 154, 170, 0.2);
				animation: pulse 2s infinite;
			}

			@keyframes pulse {
				0% {
					transform: scale(0.9);
					opacity: 0.6;
				}
				50% {
					transform: scale(1.1);
					opacity: 1;
				}
				100% {
					transform: scale(0.9);
					opacity: 0.6;
				}
			}

			.hero {
				background: linear-gradient(135deg, #0b0b10 0%, #1a1d25 50%, #0b0b10 100%);
				color: #fff;
				border-radius: var(--radius-xl);
				padding: 32px;
				display: grid;
				gap: 24px;
				position: relative;
				overflow: hidden;
				box-shadow: var(--shadow);
			}

			.hero::after {
				content: "";
				position: absolute;
				right: -10%;
				top: -30%;
				width: 320px;
				height: 320px;
				background: radial-gradient(circle, rgba(246, 167, 11, 0.45), transparent 70%);
			}

			.hero h2 {
				font-family: "Fraunces", serif;
				font-size: clamp(26px, 4vw, 38px);
				letter-spacing: -0.02em;
			}

			.hero p {
				color: rgba(255, 255, 255, 0.7);
				max-width: 560px;
				line-height: 1.6;
			}

			.hero-actions {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
			}

			.btn {
				border: none;
				padding: 12px 18px;
				border-radius: 999px;
				font-weight: 600;
				cursor: pointer;
				transition: transform 0.2s ease, box-shadow 0.2s ease;
			}

			.btn-primary {
				background: var(--sun);
				color: #1a1d25;
				box-shadow: 0 12px 24px rgba(246, 167, 11, 0.35);
			}

			.btn-secondary {
				background: rgba(255, 255, 255, 0.12);
				color: #fff;
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			.btn:hover {
				transform: translateY(-2px);
			}

			.grid {
				display: grid;
				gap: 28px;
				grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			}

			.panel {
				background: var(--mist);
				border-radius: var(--radius-lg);
				padding: 24px;
				backdrop-filter: blur(14px);
				box-shadow: 0 18px 40px rgba(15, 18, 28, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.4);
			}

			.panel h3 {
				font-size: 18px;
				margin-bottom: 12px;
			}

			.panel p {
				font-size: 14px;
				color: rgba(11, 11, 16, 0.7);
				line-height: 1.6;
			}

			.upload {
				display: grid;
				gap: 16px;
			}

			.drop {
				border: 2px dashed rgba(11, 11, 16, 0.2);
				border-radius: var(--radius-md);
				padding: 18px;
				background: rgba(255, 255, 255, 0.6);
				display: grid;
				gap: 10px;
			}

			.drop input[type="file"] {
				border-radius: 8px;
				padding: 10px;
				background: #fff;
				border: 1px solid rgba(11, 11, 16, 0.12);
				font-family: inherit;
			}

			textarea {
				width: 100%;
				min-height: 140px;
				border-radius: var(--radius-md);
				border: 1px solid rgba(11, 11, 16, 0.12);
				padding: 12px;
				font-family: "Space Grotesk", sans-serif;
				resize: vertical;
				background: #fff;
			}

			.paste-box {
				min-height: 90px;
				border-radius: var(--radius-md);
				border: 1px solid rgba(11, 11, 16, 0.12);
				padding: 12px;
				background: #fff;
				font-size: 14px;
				color: rgba(11, 11, 16, 0.7);
				outline: none;
			}

			.paste-box:focus {
				border-color: rgba(27, 154, 170, 0.6);
				box-shadow: 0 0 0 3px rgba(27, 154, 170, 0.15);
				color: var(--ink);
			}

			.paste-modal {
				position: fixed;
				inset: 0;
				background: rgba(11, 11, 16, 0.4);
				display: none;
				align-items: center;
				justify-content: center;
				padding: 24px;
				z-index: 20;
			}

			.paste-modal.is-open {
				display: flex;
			}

			.paste-modal-card {
				background: #fff;
				border-radius: var(--radius-lg);
				padding: 20px;
				max-width: 560px;
				width: 100%;
				box-shadow: var(--shadow);
				display: grid;
				gap: 12px;
			}

			.paste-modal-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 12px;
			}

			.paste-modal h4 {
				font-size: 18px;
			}

			.meta-row {
				display: grid;
				gap: 12px;
				grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			}

			select,
			input[type="text"] {
				border-radius: 999px;
				padding: 10px 14px;
				border: 1px solid rgba(11, 11, 16, 0.15);
				font-family: inherit;
				background: #fff;
			}

			.timeline {
				display: grid;
				gap: 16px;
			}

			.event-card {
				background: #fff;
				border-radius: var(--radius-md);
				padding: 16px;
				border-left: 4px solid var(--berry);
				display: grid;
				gap: 6px;
				animation: slideIn 0.4s ease;
			}

			.event-title {
				font-weight: 600;
			}

			.event-meta {
				font-size: 13px;
				color: rgba(11, 11, 16, 0.6);
			}

			.pill-row {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
			}

			.pill {
				padding: 6px 10px;
				background: rgba(27, 154, 170, 0.1);
				border-radius: 999px;
				font-size: 12px;
				color: var(--lagoon);
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translateY(12px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			footer {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				justify-content: space-between;
				align-items: center;
				font-size: 13px;
				color: rgba(11, 11, 16, 0.6);
			}

			@media (max-width: 720px) {
				.hero {
					padding: 24px;
				}

				header {
					flex-direction: column;
					align-items: flex-start;
				}
			}
		</style>
	</head>
	<body>
		<div class="page">
			<header>
				<div class="brand">
					<div class="logo"></div>
					<div>
						<h1>Ekroster</h1>
						<div class="tagline">Turn flight rosters into a clean calendar stream.</div>
					</div>
				</div>
				<div class="status-pill">
					<div class="pulse"></div>
					Ready to import
				</div>
			</header>

			<section class="hero">
			<h2>Paste your airline roster, match flights, and export a calendar in minutes.</h2>
			<p>
				Paste your roster table directly from SharePoint, preview the flights, tweak the time zone, then download an .ics
				</p>
				<div class="hero-actions">
					<button class="btn btn-primary" id="load-demo">Load demo roster</button>
					<button class="btn btn-secondary" id="clear-all">Clear</button>
				</div>
			</section>

			<section class="grid">
				<div class="panel upload">
					<h3>1. Paste your roster</h3>
					<p>Copy your roster table from SharePoint first, then click the button below.</p>
					<button class="btn btn-primary" id="paste-btn" style="width: 100%;">ðŸ“‹ Paste & Fetch Roster</button>
					<div class="meta-row">
						<select id="timezone">
							<option value="local">Use local time</option>
							<option value="utc">Convert to UTC</option>
						</select>
						<input type="text" id="calendar-name" value="Crew Roster" />
					</div>
				</div>

				<div class="panel">
					<h3>2. Preview events</h3>
					<p id="summary">No events loaded yet.</p>
					<div class="timeline" id="timeline"></div>
				</div>
			</section>

			<section class="grid">
				<div class="panel">
					<h3>3. Export calendar</h3>
					<p>Download an .ics file and import into your preferred calendar app.</p>
					<div class="pill-row" id="stats">
						<span class="pill">0 flights</span>
						<span class="pill">0 duties</span>
						<span class="pill">0 days off</span>
					</div>
					<div class="hero-actions" style="margin-top: 16px;">
						<button class="btn btn-primary" id="download-ics">Download .ics</button>
						<button class="btn btn-secondary" id="copy-ics">Copy .ics text</button>
					</div>
				</div>

				<div class="panel">
					<h3>How to import</h3>
					<p>
						- Google Calendar: Settings -> Import & export -> Import.
						<br />
						- Apple Calendar: File -> Import.
						<br />
						- Outlook: File -> Open & Export -> Import/Export.
					</p>
				</div>
			</section>

			<footer>
				<span>Built for crew workflows. Everything stays in your browser.</span>
				<span>Paste your SharePoint roster directly</span>
			</footer>
		</div>

		<div id="paste-modal" class="paste-modal" aria-hidden="true">
			<div class="paste-modal-card">
				<div class="paste-modal-header">
					<h4>Paste roster</h4>
					<button class="btn btn-secondary" id="paste-close" type="button">Close</button>
				</div>
				<p id="paste-help">Press Cmd+V to paste the roster table from SharePoint.</p>
				<div id="paste-fallback" class="paste-box" contenteditable="true"></div>
			</div>
		</div>

		<script>
			const pasteBtn = document.getElementById("paste-btn");
			const pasteModal = document.getElementById("paste-modal");
			const pasteFallback = document.getElementById("paste-fallback");
			const pasteHelp = document.getElementById("paste-help");
			const pasteClose = document.getElementById("paste-close");
			const timeline = document.getElementById("timeline");
			const summary = document.getElementById("summary");
			const stats = document.getElementById("stats");
			const calendarName = document.getElementById("calendar-name");
			const timezone = document.getElementById("timezone");
			const downloadBtn = document.getElementById("download-ics");
			const copyBtn = document.getElementById("copy-ics");
			const loadDemo = document.getElementById("load-demo");
			const clearAll = document.getElementById("clear-all");

			let events = [];
			let pastedHtml = "";

			const openPasteModal = (message) => {
				pasteHelp.textContent = message;
				pasteFallback.textContent = "";
				pasteModal.classList.add("is-open");
				pasteModal.setAttribute("aria-hidden", "false");
				setTimeout(() => pasteFallback.focus(), 0);
			};

			const closePasteModal = () => {
				pasteModal.classList.remove("is-open");
				pasteModal.setAttribute("aria-hidden", "true");
			};

			const demoText = `title,start,end,location,notes
LH123 FRA-JFK,2026-02-12 06:30,2026-02-12 09:45,Frankfurt,Flight duty
Layover JFK,2026-02-12 10:30,2026-02-13 08:00,New York,Rest period
LH124 JFK-FRA,2026-02-13 10:15,2026-02-13 20:10,New York,Return flight
Training,2026-02-15 09:00,2026-02-15 13:00,Base,Simulator session
Day Off,2026-02-16 00:00,2026-02-16 23:59,Home,`;

			const parseCSV = (text) => {
				const rows = [];
				let current = [];
				let field = "";
				let inQuotes = false;

				for (let i = 0; i < text.length; i += 1) {
					const char = text[i];
					const next = text[i + 1];

					if (char === '"' && next === '"') {
						field += '"';
						i += 1;
						continue;
					}
					if (char === '"') {
						inQuotes = !inQuotes;
						continue;
					}
					if (char === "," && !inQuotes) {
						current.push(field.trim());
						field = "";
						continue;
					}
					if ((char === "\n" || char === "\r") && !inQuotes) {
						if (field || current.length) {
							current.push(field.trim());
							rows.push(current);
							current = [];
							field = "";
						}
						continue;
					}
					field += char;
				}

				if (field || current.length) {
					current.push(field.trim());
					rows.push(current);
				}
				return rows.filter((row) => row.some((cell) => cell !== ""));
			};

			const parseTSV = (text) => {
				return text
					.split(/\r?\n/)
					.map((line) => line.split("\t").map((cell) => cell.trim()))
					.filter((row) => row.some((cell) => cell !== ""));
			};

			const parseTextToRows = (text) => {
				const hasTabs = text.includes("\t");
				return hasTabs ? parseTSV(text) : parseCSV(text);
			};

			const parseRosterDateRange = (doc) => {
				const text = doc.body ? doc.body.textContent : "";
				const matches = [...text.matchAll(/(\d{1,2})-(\d{1,2})-(\d{4})/g)];
				if (!matches.length) return null;
				const [day, month, year] = matches[0].slice(1).map(Number);
				return new Date(year, month - 1, day);
			};

			const parseHtmlTable = (html) => {
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, "text/html");
				const table = doc.querySelector("table.t2") || doc.querySelector("table");
				if (!table) return null;
				const rows = Array.from(table.querySelectorAll("tr"));
				const matrix = [];
				const rowSpans = [];

				rows.forEach((row, rowIndex) => {
					const cells = Array.from(row.querySelectorAll("td, th"));
					if (!matrix[rowIndex]) matrix[rowIndex] = [];
					let colIndex = 0;

					while (rowSpans[colIndex] > 0) {
						rowSpans[colIndex] -= 1;
						colIndex += 1;
					}

					cells.forEach((cell) => {
						const colspan = Number(cell.getAttribute("colspan") || 1);
						const rowspan = Number(cell.getAttribute("rowspan") || 1);
						const text = cell.textContent.replace(/\s+/g, " ").trim();

						for (let i = 0; i < colspan; i += 1) {
							matrix[rowIndex][colIndex + i] = text;
							if (rowspan > 1) {
								rowSpans[colIndex + i] = (rowSpans[colIndex + i] || 0) + rowspan - 1;
							}
						}

						colIndex += colspan;
						while (rowSpans[colIndex] > 0) {
							rowSpans[colIndex] -= 1;
							colIndex += 1;
						}
					});
				});

				return {
					doc,
					matrix: matrix.filter((row) => row.some((cell) => cell && cell !== "")),
				};
			};

			const normalizeHeader = (value) => value.toLowerCase().replace(/[^a-z0-9]/g, "");

			const findHeaderIndex = (headers, aliases) => {
				for (const alias of aliases) {
					const index = headers.indexOf(alias);
					if (index !== -1) return index;
				}
				return -1;
			};

			const normalizeDate = (value) => {
				const trimmed = String(value || "").trim();
				if (!trimmed) return "";
				const dmy = trimmed.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})$/);
				if (dmy) {
					const day = dmy[1].padStart(2, "0");
					const month = dmy[2].padStart(2, "0");
					const rawYear = dmy[3];
					const year = rawYear.length === 2 ? `20${rawYear}` : rawYear;
					return `${year}-${month}-${day}`;
				}
				const ymd = trimmed.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})$/);
				if (ymd) {
					const year = ymd[1];
					const month = ymd[2].padStart(2, "0");
					const day = ymd[3].padStart(2, "0");
					return `${year}-${month}-${day}`;
				}
				return trimmed;
			};

			const formatDate = (date) => {
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, "0");
				const day = String(date.getDate()).padStart(2, "0");
				return `${year}-${month}-${day}`;
			};

			const normalizeTime = (value) => {
				const trimmed = String(value || "").trim();
				if (!trimmed) return "";
				const digits = trimmed.replace(/[^0-9]/g, "");
				if (digits.length === 3) return `${digits[0]}:${digits.slice(1)}`;
				if (digits.length === 4) return `${digits.slice(0, 2)}:${digits.slice(2)}`;
				return trimmed.includes(":") ? trimmed : "";
			};

			const combineDateTime = (dateValue, timeValue) => {
				const datePart = normalizeDate(dateValue);
				const timePart = normalizeTime(timeValue);
				if (!datePart || !timePart) return "";
				return `${datePart} ${timePart}`;
			};

			const isLikelyHeaderRow = (row) => {
				if (!row || !row.length) return false;
				const normalized = row.map((cell) => normalizeHeader(cell || ""));
				return normalized.some((cell) =>
					["date", "day", "type", "flight", "from", "to", "dep", "arr", "std", "sta", "report", "end", "station"].some(
						(keyword) => cell.includes(keyword),
					)
				);
			};

			const parseRosterHtml = (content) => {
				const parsed = parseHtmlTable(content);
				if (!parsed) return [];
				const { doc, matrix } = parsed;

				const headerIndex = matrix.findIndex((row) => isLikelyHeaderRow(row));
				const hasHeader = headerIndex !== -1;
				const headers = hasHeader ? matrix[headerIndex].map((cell) => normalizeHeader(cell || "")) : [];
				const rows = hasHeader ? matrix.slice(headerIndex + 1) : matrix;

				const defaultIndexes = {
					dateIndex: 0,
					typeIndex: 1,
					repTimeIndex: 2,
					flightIndex: 3,
					depStationIndex: 4,
					depTimeIndex: 5,
					arrStationIndex: 6,
					arrTimeIndex: 7,
					endTimeIndex: 9,
				};

				const resolveIndex = (index, fallback) => (index === -1 ? fallback : index);
				const dateIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["date", "day"]) : -1, defaultIndexes.dateIndex);
				const typeIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["type", "code", "dutycode"]) : -1, defaultIndexes.typeIndex);
				const repTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["rep", "report", "std", "dept", "dep", "off", "reporttime"]) : -1,
					defaultIndexes.repTimeIndex,
				);
				const flightIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["flight", "flt", "flightno", "flightnumber"]) : -1,
					defaultIndexes.flightIndex,
				);
				const depStationIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["from", "origin", "departure", "depapt", "dep", "sta"]) : -1,
					defaultIndexes.depStationIndex,
				);
				const depTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["std", "dept", "dep", "depart", "off", "reporttime"]) : -1,
					defaultIndexes.depTimeIndex,
				);
				const arrStationIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["to", "dest", "destination", "arrapt", "arr"]) : -1,
					defaultIndexes.arrStationIndex,
				);
				const arrTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["sta", "arr", "arrive", "on", "arrivaltime"]) : -1,
					defaultIndexes.arrTimeIndex,
				);
				const endTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["end", "endtime", "finishtime", "finish"]) : -1,
					defaultIndexes.endTimeIndex,
				);
				
				const startDate = parseRosterDateRange(doc) || new Date();
				let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
				let lastDay = null;
				const dayOffCodes = new Set(["XX", "XXR", "XXV", "XXC", "DO", "LV", "EL", "ROF"]);

				return rows
					.map((row) => {
						// Extract date and update currentDate
						const dateText = dateIndex !== -1 ? row[dateIndex] : row[0] || "";
						const dayMatch = dateText.match(/\b(\d{1,2})\b/);
						if (dayMatch) {
							const day = Number(dayMatch[1]);
							if (lastDay !== null && day < lastDay) {
								currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
							}
							currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
							lastDay = day;
						}

						const typeCode = (typeIndex !== -1 ? row[typeIndex] : row[1] || "").toUpperCase().trim();
						const repTime = repTimeIndex !== -1 ? row[repTimeIndex] : row[2] || "";
						const flightNo = (flightIndex !== -1 ? row[flightIndex] : row[3] || "").trim();
						const depStation = (depStationIndex !== -1 ? row[depStationIndex] : row[4] || "").toUpperCase().trim();
						const depTime = depTimeIndex !== -1 ? row[depTimeIndex] : row[5] || "";
						const arrStation = (arrStationIndex !== -1 ? row[arrStationIndex] : row[6] || "").toUpperCase().trim();
						const arrTime = arrTimeIndex !== -1 ? row[arrTimeIndex] : row[7] || "";
						const endTime = endTimeIndex !== -1 ? row[endTimeIndex] : row[9] || "";
						const detailText = row.find((cell) => cell && cell.toLowerCase().includes("day off")) || "";

						const dateValue = formatDate(currentDate);
						
						// Check for day-off details text
						if (!flightNo && !depStation && detailText) {
							const startValue = combineDateTime(dateValue, repTime || "00:00");
							const endValue = combineDateTime(dateValue, endTime || "23:59");
							return {
								title: detailText,
								start: toDate(startValue),
								end: toDate(endValue),
								location: "",
								notes: typeCode ? `Code: ${typeCode}` : "",
							};
						}

						// Check for day-off codes
						if (!flightNo && !depStation && typeCode && dayOffCodes.has(typeCode)) {
							const startValue = combineDateTime(dateValue, repTime || "00:00");
							const endValue = combineDateTime(dateValue, endTime || "23:59");
							return {
								title: `Day Off (${typeCode})`,
								start: toDate(startValue),
								end: toDate(endValue),
								location: "",
								notes: "",
							};
						}

						// Handle flights
						if (flightNo || depStation || arrStation) {
							// Parse flight number - handle both "EK123" and "123" formats
							let flightLabel = "";
							if (flightNo) {
								if (/^[A-Z]{2}\d+/.test(flightNo)) {
									flightLabel = flightNo; // Already has airline code
								} else if (/^\d+/.test(flightNo)) {
									flightLabel = `EK${flightNo}`; // Add EK prefix if just number
								} else {
									flightLabel = flightNo;
								}
							} else {
								flightLabel = typeCode || "Flight";
							}
							
							const startValue = combineDateTime(dateValue, depTime || repTime);
							const endValue = combineDateTime(dateValue, arrTime || endTime);
							let start = toDate(startValue);
							let end = toDate(endValue);
							
							// Handle overnight flights
							if (start && end && end < start) {
								end = new Date(end.getTime());
								end.setDate(end.getDate() + 1);
							}
							
							return {
								title: `${flightLabel} ${depStation}-${arrStation}`.trim(),
								start,
								end,
								location: depStation && arrStation ? `${depStation} â†’ ${arrStation}` : depStation || arrStation || "",
								notes: typeCode && !dayOffCodes.has(typeCode) ? `Code: ${typeCode}` : "",
							};
						}

						return null;
					})
					.filter((event) => event && event.start && event.end);
			};

			const toDate = (value) => {
				if (!value) return null;
				const normalized = value.replace(/\//g, "-").trim();
				const iso = normalized.includes("T") ? normalized : normalized.replace(" ", "T");
				const parsed = new Date(iso);
				return Number.isNaN(parsed.getTime()) ? null : parsed;
			};

			const formatLocal = (date) => {
				if (!date) return "";
				return new Intl.DateTimeFormat("en-GB", {
					dateStyle: "medium",
					timeStyle: "short",
				}).format(date);
			};

			const toIcsDate = (date, useUtc) => {
				const target = useUtc ? new Date(date.getTime()) : date;
				const iso = useUtc ? target.toISOString() : new Date(target.getTime() - target.getTimezoneOffset() * 60000).toISOString();
				return iso.replace(/[-:]/g, "").replace(/\.\d{3}Z$/, useUtc ? "Z" : "");
			};

			const renderEvents = () => {
				timeline.innerHTML = "";
				if (!events.length) {
					summary.textContent = "No events loaded yet.";
					stats.innerHTML = '<span class="pill">0 flights</span><span class="pill">0 duties</span><span class="pill">0 days off</span>';
					return;
				}

				summary.textContent = `${events.length} events ready to export.`;
				let flights = 0;
				let duties = 0;
				let daysOff = 0;

				events.forEach((event) => {
					if (event.title.toLowerCase().includes("off")) daysOff += 1;
					else if (event.title.match(/\b[A-Z]{2}\d{2,4}\b/)) flights += 1;
					else duties += 1;

					const card = document.createElement("div");
					card.className = "event-card";
					card.innerHTML = `
						<div class="event-title">${event.title}</div>
						<div class="event-meta">${formatLocal(event.start)} - ${formatLocal(event.end)}</div>
						<div class="event-meta">${event.location || ""}</div>
						<div class="event-meta">${event.notes || ""}</div>
					`;
					timeline.appendChild(card);
				});

				stats.innerHTML = `
					<span class="pill">${flights} flights</span>
					<span class="pill">${duties} duties</span>
					<span class="pill">${daysOff} days off</span>
				`;
			};

			const parseRoster = async () => {
				const content = pastedHtml.trim();
				if (!content) {
					events = [];
					renderEvents();
					return;
				}

				const looksLikeHtml = /<table|<html/i.test(content);
				if (looksLikeHtml) {
					events = parseRosterHtml(content);
					events.sort((a, b) => a.start - b.start);
					renderEvents();
					return;
				}

				const rows = parseTextToRows(content);
				if (!rows.length) {
					events = [];
					renderEvents();
					return;
				}

				const headerRow = rows[0];
				const hasHeader = isLikelyHeaderRow(headerRow);
				const headers = hasHeader ? headerRow.map((cell) => normalizeHeader(cell)) : [];
				const dataRows = hasHeader ? rows.slice(1) : rows;

				const defaultIndexes = {
					dateIndex: 0,
					typeIndex: 1,
					repTimeIndex: 2,
					flightIndex: 3,
					fromIndex: 4,
					startTimeIndex: 5,
					toIndex: 6,
					endTimeIndex: 7,
					locationIndex: -1,
					notesIndex: -1,
					codeIndex: 1,
				};

				const resolveIndex = (index, fallback) => (index === -1 ? fallback : index);
				const titleIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["title", "duty", "task", "activity"]) : -1,
					-1,
				);
				const startIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["start", "starttime", "startdate"]) : -1, -1);
				const endIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["end", "endtime", "enddate"]) : -1, -1);
				const dateIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["date", "day"]) : -1, defaultIndexes.dateIndex);
				const startTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["std", "dept", "dep", "depart", "off", "report", "starttime"]) : -1,
					defaultIndexes.startTimeIndex,
				);
				const endTimeIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["sta", "arr", "arrive", "on", "endtime"]) : -1,
					defaultIndexes.endTimeIndex,
				);
				const fromIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["from", "origin", "departure", "depapt", "fromiata"]) : -1,
					defaultIndexes.fromIndex,
				);
				const toIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["to", "dest", "destination", "arrapt", "toiata"]) : -1,
					defaultIndexes.toIndex,
				);
				const locationIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["location", "base", "station"]) : -1,
					defaultIndexes.locationIndex,
				);
				const notesIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["notes", "remark", "remarks", "comment"]) : -1,
					defaultIndexes.notesIndex,
				);
				const flightIndex = resolveIndex(
					hasHeader ? findHeaderIndex(headers, ["flight", "flt", "flightno", "flightnumber"]) : -1,
					defaultIndexes.flightIndex,
				);
				const codeIndex = resolveIndex(hasHeader ? findHeaderIndex(headers, ["code", "dutycode"]) : -1, defaultIndexes.codeIndex);

				events = dataRows
					.map((row) => {
						const rawTitle =
							row[titleIndex] || row[flightIndex] || row[codeIndex] || row[0] || "Untitled";
						const from = row[fromIndex] || "";
						const to = row[toIndex] || "";
						const titleSuffix = from && to ? ` ${from}-${to}` : "";
						const title = rawTitle.includes(from) || rawTitle.includes(to) ? rawTitle : `${rawTitle}${titleSuffix}`;
						const startValue = startIndex !== -1
							? row[startIndex]
							: combineDateTime(row[dateIndex], row[startTimeIndex]);
						const endValue = endIndex !== -1
							? row[endIndex]
							: combineDateTime(row[dateIndex], row[endTimeIndex]);
						const start = toDate(startValue);
						let end = toDate(endValue);
						if (start && end && end < start) {
							end = new Date(end.getTime());
							end.setDate(end.getDate() + 1);
						}
						const location = row[locationIndex] || (from && to ? `${from} -> ${to}` : from || to || "");
						return {
							title: title || "Untitled",
							start,
							end,
							location,
							notes: row[notesIndex] || "",
						};
					})
					.filter((event) => event.start && event.end);

				events.sort((a, b) => a.start - b.start);
				renderEvents();
			};

			const buildIcs = () => {
				const useUtc = timezone.value === "utc";
				const lines = [
					"BEGIN:VCALENDAR",
					"VERSION:2.0",
					"PRODID:-//Ekroster//Roster Export//EN",
					`X-WR-CALNAME:${calendarName.value || "Crew Roster"}`,
				];

				events.forEach((event, index) => {
					const uid = `ekroster-${Date.now()}-${index}@local`;
					lines.push("BEGIN:VEVENT");
					lines.push(`UID:${uid}`);
					lines.push(`DTSTAMP:${toIcsDate(new Date(), true)}`);
					lines.push(`DTSTART:${toIcsDate(event.start, useUtc)}`);
					lines.push(`DTEND:${toIcsDate(event.end, useUtc)}`);
					lines.push(`SUMMARY:${event.title}`);
					if (event.location) lines.push(`LOCATION:${event.location}`);
					if (event.notes) lines.push(`DESCRIPTION:${event.notes}`);
					lines.push("END:VEVENT");
				});

				lines.push("END:VCALENDAR");
				return lines.join("\r\n");
			};

			const downloadIcs = () => {
				if (!events.length) return;
				const blob = new Blob([buildIcs()], { type: "text/calendar" });
				const url = URL.createObjectURL(blob);
				const link = document.createElement("a");
				link.href = url;
				link.download = `${calendarName.value || "crew-roster"}.ics`;
				link.click();
				URL.revokeObjectURL(url);
			};

			const copyIcs = async () => {
				if (!events.length) return;
				const text = buildIcs();
				await navigator.clipboard.writeText(text);
				copyBtn.textContent = "Copied";
				setTimeout(() => {
					copyBtn.textContent = "Copy .ics text";
				}, 1500);
			};

			loadDemo.addEventListener("click", () => {
				const demoHtml = `<table><tr><th>Date</th><th>Type</th><th>Flight</th><th>From</th><th>To</th><th>Start</th><th>End</th></tr><tr><td>12</td><td>Duty</td><td>EK123</td><td>DXB</td><td>LHR</td><td>06:30</td><td>12:45</td></tr><tr><td>13</td><td>XX</td><td></td><td></td><td></td><td>00:00</td><td>23:59</td></tr></table>`;
				pastedHtml = demoHtml;
				pasteBtn.textContent = "âœ“ Roster loaded";
				parseRoster();
			});

			clearAll.addEventListener("click", () => {
				pastedHtml = "";
				pasteBtn.textContent = "ðŸ“‹ Paste & Fetch Roster";
				events = [];
				renderEvents();
			});

			pasteClose.addEventListener("click", () => {
				closePasteModal();
			});

			pasteFallback.addEventListener("paste", (event) => {
				const html = event.clipboardData && event.clipboardData.getData("text/html");
				const text = event.clipboardData && event.clipboardData.getData("text/plain");
				const content = html || text || "";
				if (content) {
					event.preventDefault();
					pastedHtml = content;
					pasteBtn.textContent = "âœ“ Roster pasted";
					closePasteModal();
					parseRoster();
				}
			});

			pasteBtn.addEventListener("click", async () => {
				try {
					if (navigator.clipboard && navigator.clipboard.read) {
						const items = await navigator.clipboard.read();
						for (const item of items) {
							if (item.types.includes("text/html")) {
								const blob = await item.getType("text/html");
								const html = await blob.text();
								pastedHtml = html;
								pasteBtn.textContent = "âœ“ Roster pasted";
								await parseRoster();
								return;
							}
						}
					}

					if (navigator.clipboard && navigator.clipboard.readText) {
						const text = await navigator.clipboard.readText();
						if (text && text.trim()) {
							pastedHtml = text;
							pasteBtn.textContent = "âœ“ Roster pasted";
							await parseRoster();
							return;
						}
					}

					openPasteModal("Clipboard access is blocked in Safari. Press Cmd+V to paste the roster table.");
				} catch (err) {
					console.error("Clipboard read failed:", err);
					openPasteModal("Clipboard access failed. Press Cmd+V to paste the roster table.");
				}
			});

			downloadBtn.addEventListener("click", downloadIcs);
			copyBtn.addEventListener("click", copyIcs);

			if ("serviceWorker" in navigator) {
				window.addEventListener("load", () => {
					navigator.serviceWorker.register("./service-worker.js");
				});
			}

			renderEvents();
		</script>
	</body>
</html>

